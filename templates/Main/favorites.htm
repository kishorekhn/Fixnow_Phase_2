{% extends 'base.htm' %}

{% block title %}My Favorites | FIX-NOW{% endblock title %}

{% block content %}
{% include "Utils/navbar.htm" %} 

<div class="container mt-5">
    <h2 class="text-center mb-4">My Favorite Items</h2>

    <div class="row">
        {% for item in favorite_items %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                {% if item.service_item.main_image %}
                <img src="{{ item.service_item.main_image.url }}" class="card-img-top" alt="{{ item.service_item.name }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ item.service_item.name }}</h5>
                    <p class="card-text">{{ item.service_item.description|default:"No description."|truncatewords:20 }}</p>
                    <p class="fw-bold">Price: ‚Çπ{{ item.service_item.price }}</p>
                    <p class="small text-muted">Added on: {{ item.added_at|date:"M d, Y H:i" }}</p>

                    <button class="btn btn-danger w-100 remove-fav-btn mt-2" data-item-id="{{ item.service_item.id }}">
                        üóëÔ∏è Remove from Favorites
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-center">You have no favorites yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.querySelectorAll('.remove-fav-btn').forEach(button => {
    button.addEventListener('click', function() {
        const itemId = this.dataset.itemId;

        fetch("{% url 'toggle_favorite' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ item_id: itemId }),
            redirect: "follow"
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data.status === "removed") {
                alert("Removed from favorites!");
                location.reload(); 
            }
        });
    });
});
</script>
{% endblock scripts %}
